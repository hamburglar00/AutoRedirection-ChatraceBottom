<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="/" />
  <title>Redireccionando...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      color: #f5f5f5;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }
    .title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.4px;
    }
    .hint {
      font-size: 13px;
      opacity: 0.8;
    }
    .error {
      color: #ff6b6b;
    }
    .loader {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: #25d366;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <script>
    function getAgencyId() {
      const q = new URLSearchParams(window.location.search);
      const fromQuery = Number(q.get("agency"));
      if (Number.isInteger(fromQuery) && fromQuery > 0) return fromQuery;
      const m = window.location.pathname.match(/\/a\/(\d+)/);
      if (m) {
        const fromPath = Number(m[1]);
        if (Number.isInteger(fromPath) && fromPath > 0) return fromPath;
      }
      return null;
    }

    function buildWaUrl(phone, text) {
      const msg = text ? encodeURIComponent(text) : "";
      const clean = String(phone || "").replace(/\D/g, "");
      return "https://api.whatsapp.com/send?phone=" + clean + (msg ? "&text=" + msg : "");
    }

    const AGENCY_ID = getAgencyId();

    function setMessage(text, opts) {
      const msgEl = document.getElementById("msg");
      const hintEl = document.getElementById("hint");
      if (!msgEl) return;
      msgEl.textContent = text;
      msgEl.classList.toggle("error", !!(opts && opts.error));
      if (hintEl) {
        hintEl.textContent = opts && opts.hint ? opts.hint : "";
      }
    }

    if (!AGENCY_ID) {
      document.addEventListener("DOMContentLoaded", function () {
        setMessage(
          "Falta el par치metro de agencia en la URL.",
          {
            error: true,
            hint: "Us치 un link del tipo /a/123 (por ejemplo: /a/8)."
          }
        );
      });
    } else {
      document.addEventListener("DOMContentLoaded", function () {
        setMessage("Redireccionando a WhatsApp activo...", {
          hint: "Esto suele tardar solo un instante."
        });
        fetch("/api/get-random-phone?agency=" + AGENCY_ID, { cache: "no-store" })
          .then(function (r) {
            return r.ok ? r.json() : Promise.reject(new Error("HTTP " + r.status));
          })
          .then(function (data) {
            const phone = data && (data.number != null ? data.number : data.phone_number);
            if (!phone) throw new Error("Sin n칰mero");
            setMessage("Abriendo WhatsApp...", { hint: "" });
            const url = buildWaUrl(phone, "춰Hola! Me pas치s mi usuario 游");
            window.location.replace(url);
          })
          .catch(function () {
            setMessage(
              "No hay n칰mero disponible para esta agencia en este momento.",
              {
                error: true,
                hint: "Prob치 nuevamente en unos minutos o contact치 a soporte."
              }
            );
          });
      });
    }
  </script>
</head>
<body>
  <div class="screen">
    <div class="loader" aria-hidden="true"></div>
    <p class="title" id="msg">Conectando con la agencia...</p>
    <p class="hint" id="hint"></p>
  </div>
</body>
</html>
