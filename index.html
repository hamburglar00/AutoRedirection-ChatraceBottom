<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="/" />
  <title>Redireccionando...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0d0015;
      color: #ffbc0f;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .msg { font-size: 18px; font-weight: 600; }
    .err { color: #e74c3c; }
  </style>
  <script>
    function getAgencyId() {
      const q = new URLSearchParams(window.location.search);
      const fromQuery = Number(q.get("agency"));
      if (Number.isInteger(fromQuery) && fromQuery > 0) return fromQuery;
      const m = window.location.pathname.match(/\/a\/(\d+)/);
      if (m) {
        const fromPath = Number(m[1]);
        if (Number.isInteger(fromPath) && fromPath > 0) return fromPath;
      }
      return null;
    }

    function buildWaUrl(phone, text) {
      const msg = text ? encodeURIComponent(text) : "";
      const clean = String(phone || "").replace(/\D/g, "");
      return "https://api.whatsapp.com/send?phone=" + clean + (msg ? "&text=" + msg : "");
    }

    const AGENCY_ID = getAgencyId();
    const msgEl = document.getElementById("msg");

    function show(msg, isError) {
      document.body.innerHTML = "<p class=\"msg " + (isError ? "err" : "") + "\">" + msg + "</p>";
    }

    if (!AGENCY_ID) {
      document.addEventListener("DOMContentLoaded", () => {
        show("Falta el parÃ¡metro de agencia en la URL.\nUsÃ¡ un link del tipo /a/123 (por ejemplo: /a/8).", true);
      });
    } else {
      document.addEventListener("DOMContentLoaded", () => {
        show("Redireccionando a WhatsApp activo...");
        fetch("/api/get-random-phone?agency=" + AGENCY_ID, { cache: "no-store" })
          .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error("HTTP " + r.status)); })
          .then(function(data) {
            const phone = data && (data.number != null ? data.number : data.phone_number);
            if (!phone) throw new Error("Sin nÃºmero");
            const url = buildWaUrl(phone, "Â¡Hola! Me pasÃ¡s mi usuario ðŸš€");
            window.location.replace(url);
          })
          .catch(function() {
            show("No hay nÃºmero disponible para esta agencia en este momento.", true);
          });
      });
    }
  </script>
</head>
<body>
  <p class="msg" id="msg">Redireccionando a WhatsApp activo...</p>
</body>
</html>
